<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>demo-client</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
  .headline {
    font-size: 18px !important;
  }
  .done, .done * {
    color: #9e9e9e !important;
  }
  .done {
    margin: 5px 10px;
  }
  .v-sheet {
    border-radius: 4px;
  }
  .v-card {
    box-shadow: 0px 3px 1px -2px rgba(0, 0, 0, 0.2), 0px 2px 2px 0px rgba(0, 0, 0, 0.14), 0px 1px 5px 0px rgba(0, 0, 0, 0.12);
  }
  .v-btn {
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.0892857143em;
    /* transition-duration: 0.28s; */
  }
  </style>
</head>

<body>
  <div id="app">
    <v-app class="white">
      <!-- <v-toolbar>
        <v-toolbar-side-icon></v-toolbar-side-icon>
        <v-toolbar-title>Notifications</v-toolbar-title>
      </v-toolbar> -->
      <v-container fluid grid-list-lg>
        <v-layout row wrap>
          <v-flex xs12>
            <v-btn outline block color="indigo" @click="messagesToShow++">
              {{ Math.max(0, messages.length - messagesToShow) > 0 ? `${Math.max(0, messages.length - messagesToShow)} more updates` : `Standby` }}
            </v-btn>
          </v-flex>
          <v-flex xs12 v-for="(message, idx) in messages.slice().reverse()" v-if="messages.length - idx <= messagesToShow" v-show="message.show">
            <v-card color="" class="">
              <v-card-title primary-title>
                <div>
                  <div class="headline">{{ message.title }}</div>
                </div>
              </v-card-title>
              <v-card-text v-if="message.content">
                <span v-html="message.content"></span>
              </v-card-text>
              <v-card-text v-if="message.items">
                <v-list>
                  <v-list-tile @click="" v-for="item in message.items">
                    <v-list-tile-action>
                      <v-checkbox></v-checkbox>
                    </v-list-tile-action>
                    <v-list-tile-content>
                      <v-list-tile-title>{{ item }}</v-list-tile-title>
                    </v-list-tile-content>
                  </v-list-tile>
                </v-list>
              </v-card-text>
              <v-card-actions v-if="!message.choices">
                <v-btn flat @click="close(message)">Confirm</v-btn>
              </v-card-actions>
              <v-card-actions v-if="message.choices">
                <v-btn flat v-for="choice in message.choices" @click="choiceSelected(message, choice)">{{ choice.text }}</v-btn>
              </v-card-actions>
            </v-card>
          </v-flex>
          <v-flex xs12 v-for="message in archive.slice().reverse()" v-show="!message.show">
              <v-card color="" class="done">
                <v-card-title primary-title>
                  <div>
                    <div class="headline">{{ message.title }}</div>
                  </div>
                </v-card-title>
                <v-card-text v-if="message.content">
                    <span v-html="message.content"></span>
                  </v-card-text>
                  <v-card-text v-if="message.items">
                    <v-list>
                      <v-list-tile @click="" v-for="item in message.items">
                        <v-list-tile-action>
                          <v-checkbox></v-checkbox>
                        </v-list-tile-action>
                        <v-list-tile-content>
                          <v-list-tile-title>{{ item }}</v-list-tile-title>
                        </v-list-tile-content>
                      </v-list-tile>
                    </v-list>
                  </v-card-text>
              </v-card>
            </v-flex>
        </v-layout>
      </v-container>
    </v-app>
  </div>

  <script src="//cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="//cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.js"></script>
  <script src="//unpkg.com/@feathersjs/client@^3.0.0/dist/feathers.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io()  // io('http://localhost:3030')
    const client = feathers()
    client.configure(feathers.socketio(socket))

    let params = (new URL(document.location)).searchParams
    let host = params.get("host") || "localhost:9000"
    let wsUri = `ws://${host}/api/ws/demo-client`
    let isReconnecting = false

    const tempId = Math.random().toString(36).substr(2, 9)

    new Vue({
      el: '#app',
      data: function () {
        return {
          "messages": [],
          "messagesToShow": 1,
          "archive": []
        }
      },
      methods: {
        async close (message) {
          this.archive.push(message)
          message.show = false
          let activeLength = this.messagesToShow - this.archive.length
          console.log(activeLength)
          if (activeLength === 0) {
            this.messagesToShow++
          }
        },
        async choiceSelected (message, choice) {
          if (choice.action) {
            let resp = Object.assign(choice.action.params, {
              "name": "ID: " + tempId,
              "date": moment().format()
            })
            await client.service(choice.action.endpointInternal).create(resp)
          }
          if (choice.close) {
            this.close(message)
          }
        },
        connect () {
          let ws = new WebSocket(wsUri)

          ws.onopen = (ev) => {
            isReconnecting = false
            this.messages.push(
              {
                "title": "Connected",
                "content": "",
                "footer": "",
                "show": true
              }
            )
          }

          ws.onclose = (ev) => {
            if (isReconnecting === false) {
              this.messages.push(
                {
                  "title": "Disonnected",
                  "content": "",
                  "footer": "",
                  "show": true
                }
              )
            }
            isReconnecting = true
            setTimeout(() => { this.connect() }, 1000)
          }

          ws.onmessage = (ev) => {
            let payload = JSON.parse(ev.data)
            console.log(payload)
            if (payload.params.items) {
            }
            this.messages.push(
              {
                "title": payload.params.title,
                "content": payload.params.content,
                "items": payload.params.items,
                "footer": payload.params.footer,
                "choices": payload.params.choices,
                "show": true
              }
            )
          }
        }
      },
      mounted: function () {
        let appEl = document.getElementById('app')
        appEl.scrollTop = appEl.scrollHeight
        this.connect()
      }
    })
  </script>
</body>

</html>